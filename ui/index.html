<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compiscript IDE — oscuro</title>
  <style>
    :root{
      --bg:#0b0e12; --panel:#0f131a; --mut:#9aa3b2; --txt:#e6edf3; --accent:#7dd3fc; --b:#1f2937; --b2:#233043; --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .layout{display:grid;grid-template-rows:auto 1fr auto;height:100%}
    header,footer{padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--b)}
    footer{border-top:1px solid var(--b);border-bottom:none;color:var(--mut);font-size:12px}
    .main{display:grid;grid-template-columns:280px 1fr; min-height:0}
    .sidebar{border-right:1px solid var(--b);background:var(--panel);padding:8px;overflow:auto}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    button,.btn{padding:6px 10px;border:1px solid var(--b2);border-radius:10px;background:#111827;color:var(--txt);cursor:pointer}
    button:hover,.btn:hover{background:#0b1220}
    .danger{border-color:#3b1212;color:#fecaca;background:#3b1212}
    .mut{color:var(--mut)}
    .files{list-style:none;padding:0;margin:8px 0}
    .files li{padding:6px 8px;border-radius:8px;display:flex;align-items:center;gap:6px;cursor:pointer}
    .files li.active{background:#111827;border:1px solid var(--b2)}
    .tabs{display:flex;gap:6px;background:var(--panel);border-bottom:1px solid var(--b);padding:6px}
    .tab{padding:6px 10px;border:1px solid var(--b2);border-bottom:none;border-radius:8px 8px 0 0;background:#0b1220;cursor:pointer}
    .tab.active{background:#111827}
    #editor{height:calc(100% - 170px)}
    #panel{height:140px;border-top:1px solid var(--b);background:#0b1220;padding:8px 12px;font:12px ui-monospace,Menlo,Consolas,monospace;overflow:auto;white-space:pre-wrap}
    input[type="file"]{display:none}
    .drop{border:2px dashed var(--b2);border-radius:12px;padding:10px;text-align:center;color:var(--mut);margin-top:8px}
  </style>
  <!-- Monaco & JSZip (CDN) -->
  <script src="https://unpkg.com/monaco-editor@0.43.0/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<div class="layout">
  <header>
    <div class="row">
      <strong>Compiscript IDE</strong>
      <button id="runBtn">Compilar (Ctrl+Enter)</button>
      <button id="delLinesBtn">Eliminar líneas seleccionadas</button>
      <span class="grow"></span>
      <label class="mut">Tamaño</label>
      <input id="fontRange" type="range" min="12" max="22" value="14"/>
      <span id="cursor" class="mut" style="margin-left:12px">L1:C1</span>
      <span id="status" style="margin-left:16px;font-weight:600;color:var(--mut)">Listo</span>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <div class="row">
        <span style="font-weight:600">Archivos</span>
        <span class="grow"></span>
        <button id="newFile">Nuevo</button>
      </div>
      <div class="row" style="margin-top:6px;gap:6px">
        <button id="uploadBtn">Subir archivos</button>
        <button id="uploadDirBtn">Subir carpeta</button>
      </div>
      <div class="row" style="margin-top:6px;gap:6px">
        <button id="downloadBtn">Descargar archivo</button>
        <button id="zipBtn">Descargar proyecto</button>
      </div>
      <div id="drop" class="drop">Arrastra aquí archivos o carpetas</div>
      <input id="fileInput" type="file" multiple />
      <input id="dirInput" type="file" webkitdirectory directory multiple />
      <ul id="fileList" class="files"></ul>
    </aside>

    <section style="display:flex;flex-direction:column;min-width:0">
      <div id="tabs" class="tabs"></div>
      <div id="editor"></div>
      <div id="panel"></div>
    </section>
  </div>

  <footer>
    API: <code>http://localhost:8000/analyze</code> — Tema oscuro. Soporta subir archivos/carpeta, arrastrar y soltar, pestañas, borrar líneas, descargar ZIP, autosave.
  </footer>
</div>

<script>
  const API_URL = "http://localhost:8000/analyze"; // ajusta si cambias puerto
  const storeKey = "csp-project-v2";

  // ------------------
  // Proyecto en memoria
  // ------------------
  function emptyProject(){
    return {
      files: {"main.cps":`// Bienvenido a Compiscript\nlet a: integer = 1;\nlet b: integer = 2;\nlet c = a + b;\nprint(c);\n`},
      open: ["main.cps"],
      active: "main.cps"
    };
  }
  function loadProject(){
    try { const raw = localStorage.getItem(storeKey); if(raw) return JSON.parse(raw); } catch{};
    return emptyProject();
  }
  function saveProject(){ localStorage.setItem(storeKey, JSON.stringify(project)); }
  let project = loadProject();

  // ------------------
  // Utilidades de árbol
  // ------------------
  function buildTree(paths){
    const root = { name:"/", kind:"dir", children:{} };
    for(const p of paths){
      const parts = p.split("/").filter(Boolean);
      let node = root;
      for(let i=0;i<parts.length;i++){
        const part = parts[i];
        if(i === parts.length-1){
          node.children[part] = { name: part, path: p, kind: "file" };
        } else {
          node.children[part] = node.children[part] || { name: part, kind:"dir", children:{} };
          node = node.children[part];
        }
      }
    }
    return root;
  }

  function renderTree(){
    const list = document.getElementById('fileList');
    list.innerHTML = "";
    const tree = buildTree(Object.keys(project.files));
    function renderNode(node, container){
      if(node.kind === 'dir'){
        const keys = Object.keys(node.children).sort((a,b)=>a.localeCompare(b));
        keys.forEach(k=> renderNode(node.children[k], container));
      } else {
        const li = document.createElement('li');
        li.className = (node.path===project.active? 'active':'');
        const name = document.createElement('span'); name.textContent = node.path; name.style.flex = '1';
        const ren = document.createElement('button'); ren.textContent = 'Ren';
        const del = document.createElement('button'); del.textContent = 'Del';
        li.appendChild(name); li.appendChild(ren); li.appendChild(del);
        li.onclick = ()=> openFile(node.path);
        ren.onclick = (e)=>{ e.stopPropagation(); const nn = prompt('Nuevo nombre', node.path) || node.path; if(nn===node.path) return; if(project.files[nn]){ alert('Ya existe'); return; } const content = project.files[node.path]; delete project.files[node.path]; project.files[nn]=content; project.open = project.open.map(x=> x===node.path? nn : x); if(project.active===node.path) project.active=nn; saveProject(); refreshAll(); };
        del.onclick = (e)=>{ e.stopPropagation(); if(!confirm('Eliminar '+node.path+'?')) return; delete project.files[node.path]; project.open = project.open.filter(x=>x!==node.path); if(project.active===node.path){ project.active=Object.keys(project.files)[0]||""; if(project.active && !project.open.includes(project.active)) project.open.push(project.active); } saveProject(); refreshAll(); };
        container.appendChild(li);
      }
    }
    renderNode(tree, list);
  }

  function renderTabs(){
    const bar = document.getElementById('tabs');
    bar.innerHTML = '';
    project.open.forEach(n=>{
      const div = document.createElement('div');
      div.className = 'tab'+(n===project.active?' active':'');
      div.textContent = n; div.title = n; div.onclick = ()=> openFile(n);
      bar.appendChild(div);
    });
  }

  function openFile(path){
    const content = project.files[path];
    if(content==null) return;
    project.active = path;
    if(!project.open.includes(path)) project.open.push(path);
    editor.setValue(content);
    editor.focus();
    saveProject();
    renderTabs(); renderTree();
  }

  function updateActiveContent(){
    const p = project.active; if(!p) return;
    project.files[p] = editor.getValue();
    saveProject();
  }

  // ------------------
  // Monaco
  // ------------------
  let editor;
  require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.43.0/min/vs' }});
  require(['vs/editor/editor.main'], function(){
    monaco.editor.setTheme('vs-dark');
    // Desactiva validaciones de TS si se usa typescript
    try{ monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({ noSemanticValidation:true, noSyntaxValidation:true }); }catch{}

    editor = monaco.editor.create(document.getElementById('editor'), {
      value: '', language: 'plaintext', automaticLayout: true, minimap:{enabled:false}, fontSize:14, lineNumbers:'on', wordWrap:'off'
    });

    // cursor pos
    editor.onDidChangeCursorPosition(e=>{
      const p = editor.getPosition();
      document.getElementById('cursor').textContent = `L${p.lineNumber}:C${p.column}`;
    });

    // Ctrl+Enter compilar
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&& e.key==='Enter'){ analyzeActive(); } });

    openFile(project.active || Object.keys(project.files)[0]);
  });

  // ------------------
  // Acciones UI
  // ------------------
  function setStatus(text, ok=true){ const s=document.getElementById('status'); s.textContent=text; s.style.color = ok? 'var(--ok)' : 'var(--danger)'; }
  function setPanel(text){ document.getElementById('panel').textContent = text; }

  document.getElementById('fontRange').addEventListener('input', (e)=>{
    if(!editor) return; editor.updateOptions({fontSize: Number(e.target.value)});
  });
  document.getElementById('runBtn').onclick = analyzeActive;
  document.getElementById('delLinesBtn').onclick = deleteSelectedLines;
  document.getElementById('newFile').onclick = ()=>{ const name = prompt('Nombre del archivo', 'nuevo.cps'); if(!name) return; if(project.files[name]){ alert('Ya existe'); return;} project.files[name] = ''; project.active = name; if(!project.open.includes(name)) project.open.push(name); saveProject(); refreshAll(); };

  document.getElementById('uploadBtn').onclick = ()=> document.getElementById('fileInput').click();
  document.getElementById('uploadDirBtn').onclick = ()=> document.getElementById('dirInput').click();

  // input de archivos
  function handleFileList(fileList){
    const promises = [];
    for(const file of fileList){
      promises.push(new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload = ()=>{ resolve({ path: (file.webkitRelativePath||file.name), content: reader.result }); };
        reader.readAsText(file);
      }));
    }
    Promise.all(promises).then(items=>{
      items.forEach(it=>{
        const path = it.path.replace(/\\/g,'/');
        if(project.files[path] && !confirm(`Sobrescribir ${path}?`)) return;
        project.files[path] = String(it.content||'');
        if(!project.open.includes(path)) project.open.push(path);
        project.active = path;
      });
      saveProject(); refreshAll();
    });
  }
  document.getElementById('fileInput').addEventListener('change', (e)=> handleFileList(e.target.files));
  document.getElementById('dirInput').addEventListener('change', (e)=> handleFileList(e.target.files));

  // Drag & drop
  const drop = document.getElementById('drop');
  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = 'var(--accent)'; }));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = 'var(--b2)'; }));
  drop.addEventListener('drop', (e)=>{
    const items = e.dataTransfer.items;
    if(items && items.length){
      const files = [];
      // soporta carpetas con DataTransferItem.webkitGetAsEntry
      const promises = [];
      for(const it of items){
        const entry = it.webkitGetAsEntry && it.webkitGetAsEntry();
        if(entry){ promises.push(readEntryRecursive(entry)); }
      }
      if(promises.length){
        Promise.all(promises).then(arrays=> handleFileList(new FileListFromArray(arrays.flat())));
      } else if(e.dataTransfer.files){
        handleFileList(e.dataTransfer.files);
      }
    }
  });

  // helper: leer entradas recursivas (Chrome/Edge)
  function readEntryRecursive(entry, path=""){ return new Promise(resolve=>{
    if(entry.isFile){ entry.file(f=>{ f.webkitRelativePath = path+entry.name; resolve([f]); }); }
    else if(entry.isDirectory){ const dirReader = entry.createReader(); let entries=[]; const acc=()=> dirReader.readEntries(rs=>{ if(!rs.length) { Promise.all(entries.map(en=> readEntryRecursive(en, path+entry.name+"/"))).then(x=> resolve(x.flat())); } else { entries.push(...rs); acc(); } }); acc(); }
    else resolve([]);
  });
  }

  // construir FileList desde array de File
  function FileListFromArray(files){ const dt = new DataTransfer(); files.forEach(f=> dt.items.add(f)); return dt.files; }

  // Descargar archivo actual
  document.getElementById('downloadBtn').onclick = ()=>{
    updateActiveContent(); const p = project.active; if(!p) return; const blob = new Blob([project.files[p]||''], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = p.split('/').pop(); a.click(); URL.revokeObjectURL(a.href);
  };

  // Descargar proyecto como ZIP
  document.getElementById('zipBtn').onclick = async()=>{
    updateActiveContent(); const zip = new JSZip();
    for(const [path,content] of Object.entries(project.files)){ zip.file(path, content); }
    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'compiscript-project.zip'; a.click(); URL.revokeObjectURL(a.href);
  };

  // Eliminar líneas seleccionadas (bloque)
  function deleteSelectedLines(){ if(!editor) return; const sel = editor.getSelection(); if(!sel) return; const model = editor.getModel(); const last = model.getLineCount(); const start = sel.startLineNumber; const end = sel.endLineNumber; const range = new monaco.Range(start,1, Math.min(end+1,last), 1); editor.executeEdits('deleteLines', [{range, text:''}]); }

  // Analizar
  async function analyzeActive(){
    updateActiveContent();
    const p = project.active; if(!p){ setStatus('Sin archivo activo', false); return; }
    const code = project.files[p]||'';
    setStatus('Compilando...', true); setPanel('');
    monaco.editor.setModelMarkers(editor.getModel(), 'csp', []);
    try{
      const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})});
      const data = await res.json();
      if(data.ok){ setStatus('OK ✓', true); setPanel('Sin errores.'); }
      else{
        const markers = (data.diagnostics||[]).map(d=>({
          severity: monaco.MarkerSeverity.Error,
          message: d.message || 'Error',
          startLineNumber: Number(d.line)||1,
          startColumn: (Number(d.column)||0)+1,
          endLineNumber: Number(d.line)||1,
          endColumn: ((Number(d.column)||0)+2),
          source:'Compiscript'
        }));
        monaco.editor.setModelMarkers(editor.getModel(), 'csp', markers);
        setStatus(data.kind==='syntax'?'Errores de sintaxis':data.kind==='semantic'?'Errores semánticos':'Error interno', false);
        setPanel((data.diagnostics||[]).map(d=>`[L${d.line}:C${d.column}] ${d.message}`).join("\n") || 'Error');
      }
    }catch(e){ setStatus('No se pudo contactar la API', false); setPanel(String(e)); }
  }

  function refreshAll(){ renderTabs(); renderTree(); openFile(project.active || Object.keys(project.files)[0]); }
</script>
</body>
</html>
